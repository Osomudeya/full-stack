name: Build and Deploy Backend + Frontend to Azure AKS

on:
  # pull_request:
  #   branches:
  #     - main
  #   types: [closed]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running the workflow'
        required: false
        type: string

env:
  # AKS Configuration
  AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
  AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
  
  # Container Registry Configuration
  ACR_LOGIN_SERVER: "appacr94.azurecr.io"  
  ACR_NAME: "appacr94"
  
  # Application Configuration
  BACKEND_IMAGE_NAME: memory-game-backend
  FRONTEND_IMAGE_NAME: memory-game-frontend
  BACKEND_DEPLOYMENT_NAME: backend
  FRONTEND_DEPLOYMENT_NAME: frontend
  IMAGE_TAG: ${{ github.sha }}
  NAMESPACE: memory-game
  
  # Bastion Configuration
  BASTION_HOST: "20.234.218.15"  
  BASTION_USER: azureuser
  BASTION_PASSWORD: ${{ secrets.JUMPBOX_PASSWORD }}
  KUBECONFIG: ~/.kube/config
  
  # üêò Database Configuration (Non-sensitive)
  DB_NAME: "gamedb"
  DB_APP_USER: "gameapp"
  PG_SERVER_NAME: ""  # Leave empty for auto-detection, or specify server name
  
  # üîê Database Secrets (Sensitive - stored in GitHub Secrets)
  DB_APP_PASSWORD: ${{ secrets.DB_APP_PASSWORD }}
  PG_ADMIN_PASSWORD: ${{ secrets.PG_ADMIN_PASSWORD }}

jobs:
  build-push-deploy:
    name: Build, Push, and Deploy Backend + Frontend
    runs-on: ubuntu-latest
    environment: development

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Log in to ACR
      run: |
        az acr login --name ${{ env.ACR_NAME }}

    - name: Build and Push Backend Image
      run: |
        echo "üî® Building backend image with tag: ${{ env.IMAGE_TAG }}"
        docker build -f ./application/backend/Dockerfile -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }} ./application/backend
        docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        echo "‚úÖ Backend image pushed successfully"

    - name: Build and Push Frontend Image
      run: |
        echo "üî® Building frontend image with tag: ${{ env.IMAGE_TAG }}"
        docker build -f ./application/frontend/Dockerfile -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }} ./application/frontend
        docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        echo "‚úÖ Frontend image pushed successfully"

      # Add image scanning step
    - name: Scan Images for Vulnerabilities
      run: |
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
        aquasec/trivy:latest image \
        ${{ env.ACR_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    - name: Install SSH dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass

    - name: Clear old deployment files on Bastion
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.BASTION_HOST }}
        username: ${{ env.BASTION_USER }}
        password: ${{ env.BASTION_PASSWORD }}
        port: 22
        script: |
          echo "üßπ Cleaning up old deployment files..."
          rm -rf /tmp/application
          rm -rf /tmp/run-deploy.sh
          echo "‚úÖ Cleanup completed"

    - name: Copy Kubernetes Manifests to Bastion
      run: |
        echo "üì¶ Copying Kubernetes manifests to bastion host..."
        sshpass -p "${{ env.BASTION_PASSWORD }}" scp -o StrictHostKeyChecking=no -r ./kubernetes/application ${{ env.BASTION_USER }}@${{ env.BASTION_HOST }}:/tmp/application
        echo "‚úÖ Manifests copied successfully"

    - name: Copy Enhanced Deployment Script to Bastion
      run: |
        echo "üìú Copying enhanced deployment script to bastion host..."
        sshpass -p "${{ env.BASTION_PASSWORD }}" scp -o StrictHostKeyChecking=no .github/scripts/run-deploy.sh ${{ env.BASTION_USER }}@${{ env.BASTION_HOST }}:/tmp/run-deploy.sh
        echo "‚úÖ Deployment script copied successfully"

    - name: Run Enhanced Deployment Script with Database Configuration
      uses: appleboy/ssh-action@v1.0.3
      env:
        # Container Configuration
        ACR_LOGIN_SERVER: ${{ env.ACR_LOGIN_SERVER }}
        ACR_NAME: ${{ env.ACR_NAME }}
        IMAGE_TAG: ${{ env.IMAGE_TAG }}
        BACKEND_DEPLOYMENT_NAME: ${{ env.BACKEND_DEPLOYMENT_NAME }}
        FRONTEND_DEPLOYMENT_NAME: ${{ env.FRONTEND_DEPLOYMENT_NAME }}
        BACKEND_IMAGE_NAME: ${{ env.BACKEND_IMAGE_NAME }}
        FRONTEND_IMAGE_NAME: ${{ env.FRONTEND_IMAGE_NAME }}
        NAMESPACE: ${{ env.NAMESPACE }}
        
        # AKS Configuration
        AKS_CLUSTER_NAME: ${{ env.AKS_CLUSTER_NAME }}
        AKS_RESOURCE_GROUP: ${{ env.AKS_RESOURCE_GROUP }}
        
        # üêò Database Configuration
        DB_NAME: ${{ env.DB_NAME }}
        DB_APP_USER: ${{ env.DB_APP_USER }}
        DB_APP_PASSWORD: ${{ env.DB_APP_PASSWORD }}
        PG_SERVER_NAME: ${{ env.PG_SERVER_NAME }}
        PG_ADMIN_PASSWORD: ${{ env.PG_ADMIN_PASSWORD }}
        
      with:
        host: ${{ env.BASTION_HOST }}
        username: ${{ env.BASTION_USER }}
        password: ${{ env.BASTION_PASSWORD }}
        port: 22
        envs: ACR_LOGIN_SERVER,ACR_NAME,IMAGE_TAG,BACKEND_DEPLOYMENT_NAME,FRONTEND_DEPLOYMENT_NAME,BACKEND_IMAGE_NAME,FRONTEND_IMAGE_NAME,NAMESPACE,AKS_CLUSTER_NAME,AKS_RESOURCE_GROUP,DB_NAME,DB_APP_USER,DB_APP_PASSWORD,PG_SERVER_NAME,PG_ADMIN_PASSWORD
        script: |
          echo "üöÄ Starting enhanced deployment with Azure PostgreSQL configuration..."
          chmod +x /tmp/run-deploy.sh
          
          # Set PGPASSWORD for non-interactive PostgreSQL operations
          export PGPASSWORD="$PG_ADMIN_PASSWORD"
          
          bash -x /tmp/run-deploy.sh
          
          echo ""
          echo "üéØ Final deployment status:"
          kubectl get pods -n memory-game
          echo ""
          echo "‚úÖ Deployment pipeline completed!"


# name: Build and Deploy Backend + Frontend to Azure AKS

# on:
#   # pull_request:
#   #   branches:
#   #     - main
#   #   types: [closed]
#   workflow_dispatch:
#     inputs:
#       reason:
#         description: 'Reason for running the workflow'
#         required: false
#         type: string

# env:
#   AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
#   AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
#   BACKEND_IMAGE_NAME: memory-game-backend
#   FRONTEND_IMAGE_NAME: memory-game-frontend
#   BACKEND_DEPLOYMENT_NAME: backend
#   FRONTEND_DEPLOYMENT_NAME: frontend
#   IMAGE_TAG: ${{ github.sha }}
#   NAMESPACE: memory-game
#   BASTION_HOST: ${{ secrets.JUMPBOX_IP }}
#   BASTION_USER: azureuser
#   BASTION_PASSWORD: ${{ secrets.JUMPBOX_PASSWORD }}
#   KUBECONFIG: ~/.kube/config
#   ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
#   ACR_NAME: ${{ secrets.ACR_NAME }}


# jobs:
#   build-push-deploy:
#     # if: github.event.pull_request.merged == true
#     name: Build, Push, and Deploy Backend + Frontend
#     runs-on: ubuntu-latest
#     environment: development

#     steps:
#     - name: Checkout Code
#       uses: actions/checkout@v3

#     - name: Log in to Azure
#       uses: azure/login@v1
#       with:
#         creds: ${{ secrets.AZURE_CREDENTIALS }}

#     - name: Log in to ACR
#       run: |
#         az acr login --name ${{ env.ACR_NAME }}

#     - name: Build and Push Backend Image
#       run: |
#         docker build -f ./application/backend/Dockerfile -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }} ./application/backend
#         docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

#     - name: Build and Push Frontend Image
#       run: |
#         docker build -f ./application/frontend/Dockerfile -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }} ./application/frontend
#         docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

#     - name: Install SSH dependencies
#       run: |
#         sudo apt-get update
#         sudo apt-get install -y sshpass

#     - name: Clear old deployment files on Bastion
#       uses: appleboy/ssh-action@v1.0.3
#       with:
#         host: ${{ env.BASTION_HOST }}
#         username: ${{ env.BASTION_USER }}
#         password: ${{ env.BASTION_PASSWORD }}
#         script: |
#           rm -rf /tmp/application
#           rm -rf /tmp/run-deploy.sh

#     - name: Copy Kubernetes Manifests to Bastion
#       run: |
#         sshpass -p "${{ env.BASTION_PASSWORD }}" scp -o StrictHostKeyChecking=no -r ./kubernetes/application ${{ env.BASTION_USER }}@${{ env.BASTION_HOST }}:/tmp/application
#         # sshpass -p "${{ env.BASTION_PASSWORD }}" scp -o StrictHostKeyChecking=no -r ./kubernetes/monitoring ${{ env.BASTION_USER }}@${{ env.BASTION_HOST }}:/tmp/monitoring

#     - name: Copy Deployment Script to Bastion
#       run: |
#         sshpass -p "${{ env.BASTION_PASSWORD }}" scp -o StrictHostKeyChecking=no -r .github/scripts/run-deploy.sh ${{ env.BASTION_USER }}@${{ env.BASTION_HOST }}:/tmp/run-deploy.sh

#     - name: Run Deployment Script on Bastion
#       uses: appleboy/ssh-action@v1.0.3
#       env:
#         ACR_LOGIN_SERVER: ${{ env.ACR_LOGIN_SERVER }}
#         IMAGE_TAG: ${{ env.IMAGE_TAG }}
#         BACKEND_DEPLOYMENT_NAME: ${{ env.BACKEND_DEPLOYMENT_NAME }}
#         FRONTEND_DEPLOYMENT_NAME: ${{ env.FRONTEND_DEPLOYMENT_NAME }}
#         BACKEND_IMAGE_NAME: ${{ env.BACKEND_IMAGE_NAME }}
#         FRONTEND_IMAGE_NAME: ${{ env.FRONTEND_IMAGE_NAME }}
#         NAMESPACE: ${{ env.NAMESPACE }}
#       with:
#         host: ${{ env.BASTION_HOST }}
#         username: ${{ env.BASTION_USER }}
#         password: ${{ env.BASTION_PASSWORD }}
#         envs: ACR_LOGIN_SERVER,IMAGE_TAG,BACKEND_DEPLOYMENT_NAME,FRONTEND_DEPLOYMENT_NAME,BACKEND_IMAGE_NAME,FRONTEND_IMAGE_NAME,NAMESPACE
#         script: |
#           bash -x /tmp/run-deploy.sh